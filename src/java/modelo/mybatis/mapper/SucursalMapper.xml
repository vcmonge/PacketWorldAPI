<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sucursal">

    <resultMap id="sucursalResultMap" type="pojo.Sucursal">
        <id property="idSucursal" column="idSucursal"/>
        <result property="codigo" column="codigo"/>
        <result property="nombre" column="nombre"/>
        <result property="estatus" column="estatus"/>
        <result property="idDireccion" column="idDireccion"/>
        
        <result property="direccionCompleta" column="direccionCompleta"/>
        
        <result property="calle" column="calle"/>
        <result property="numero" column="numero"/>
        <result property="idColonia" column="idColonia"/>
        <result property="nombreColonia" column="nombreColonia"/>
    </resultMap>

    <select id="obtenerTodos" resultMap="sucursalResultMap">
        SELECT 
            s.idSucursal, 
            s.codigo, 
            s.nombre, 
            s.estatus, 
            s.idDireccion,
            /* Concatenación estilo Envío para mostrar todo en una línea */
            CONCAT(d.calle, ' #', d.numero, ', Col. ', c.nombre, ', CP ', c.codigo_postal, ', ', m.nombre, ', ', e.nombre) AS direccionCompleta,
            /* Datos crudos necesarios para los formularios de edición */
            d.calle,
            d.numero,
            d.idColonia,
            c.nombre AS nombreColonia
        FROM sucursal s
        INNER JOIN direccion d ON s.idDireccion = d.idDireccion
        INNER JOIN colonias c ON d.idColonia = c.id
        INNER JOIN municipios m ON c.municipio = m.id
        INNER JOIN estados e ON m.estado = e.id
    </select>
    
    <select id="obtenerActivas" resultMap="sucursalResultMap">
        SELECT 
            s.idSucursal, 
            s.codigo, 
            s.nombre, 
            s.estatus, 
            s.idDireccion,
            CONCAT(d.calle, ' #', d.numero, ', Col. ', c.nombre, ', CP ', c.codigo_postal, ', ', m.nombre, ', ', e.nombre) AS direccionCompleta,
            d.calle,
            d.numero,
            d.idColonia,
            c.nombre AS nombreColonia
        FROM sucursal s
        INNER JOIN direccion d ON s.idDireccion = d.idDireccion
        INNER JOIN colonias c ON d.idColonia = c.id
        INNER JOIN municipios m ON c.municipio = m.id
        INNER JOIN estados e ON m.estado = e.id
        WHERE s.estatus = 'activa'
    </select>

    <insert id="registrarDireccion" parameterType="pojo.Sucursal" useGeneratedKeys="true" keyProperty="idDireccion">
        INSERT INTO direccion (calle, numero, idColonia) 
        VALUES (#{calle}, #{numero}, #{idColonia})
    </insert>

    <insert id="registrar" parameterType="pojo.Sucursal">
        INSERT INTO sucursal (codigo, nombre, estatus, idDireccion) 
        VALUES (#{codigo}, #{nombre}, #{estatus}, #{idDireccion})
    </insert>
    
    <update id="editar" parameterType="pojo.Sucursal">
        UPDATE sucursal SET nombre = #{nombre} WHERE idSucursal = #{idSucursal}
    </update>

    <update id="editarDireccion" parameterType="pojo.Sucursal">
        UPDATE direccion SET calle = #{calle}, numero = #{numero}, idColonia = #{idColonia}
        WHERE idDireccion = #{idDireccion}
    </update>
    
    <update id="eliminar" parameterType="int">
        UPDATE sucursal SET estatus = 'inactiva' WHERE idSucursal = #{idSucursal}
    </update>

</mapper>