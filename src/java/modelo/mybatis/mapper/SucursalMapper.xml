<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sucursal">

    <select id="obtener-sucursales" resultType="pojo.Sucursal">
        SELECT 
            s.idSucursal, 
            s.codigo, 
            s.nombre, 
            s.estatus,
            s.idDireccion,
            d.calle,
            d.numero,
            d.idColonia,
            col.nombre AS nombreColonia,
            col.codigo_postal AS codigoPostal,
            m.nombre AS ciudad,
            e.nombre AS estado,
            CONCAT_WS(', ', CONCAT_WS(' ', d.calle, d.numero), NULLIF(col.nombre, ''), CONCAT('C.P. ', NULLIF(col.codigo_postal, '')), NULLIF(m.nombre, ''), NULLIF(e.nombre, '') ) AS direccionCompleta
        FROM sucursal s
        INNER JOIN direccion d ON s.idDireccion = d.idDireccion
        LEFT JOIN colonias col ON d.idColonia = col.id
        LEFT JOIN municipios m ON col.municipio = m.id
        LEFT JOIN estados e ON m.estado = e.id
    </select>
    
    <select id="obtener-activas" resultType="pojo.Sucursal">
        SELECT 
            s.idSucursal, 
            s.codigo, 
            s.nombre, 
            s.estatus,
            s.idDireccion,
            d.calle,
            d.numero,
            d.idColonia,
            col.nombre AS nombreColonia,
            col.codigo_postal AS codigoPostal,
            m.nombre AS ciudad,
            e.nombre AS estado,
            CONCAT_WS(', ', CONCAT_WS(' ', d.calle, d.numero), NULLIF(col.nombre, ''), CONCAT('C.P. ', NULLIF(col.codigo_postal, '')), NULLIF(m.nombre, ''), NULLIF(e.nombre, '') ) AS direccionCompleta
        FROM sucursal s
        INNER JOIN direccion d ON s.idDireccion = d.idDireccion
        LEFT JOIN colonias col ON d.idColonia = col.id
        LEFT JOIN municipios m ON col.municipio = m.id
        LEFT JOIN estados e ON m.estado = e.id
        WHERE s.estatus = 'activa'
    </select>
    
    <select id="buscar-sucursal-id" resultType="pojo.Sucursal" parameterType="int">
        SELECT 
            s.idSucursal, 
            s.codigo, 
            s.nombre, 
            s.estatus,
            s.idDireccion,
            d.calle,
            d.numero,
            d.idColonia,
            col.nombre AS nombreColonia,
            col.codigo_postal AS codigoPostal,
            m.nombre AS ciudad,
            e.nombre AS estado,
            CONCAT_WS(', ', CONCAT_WS(' ', d.calle, d.numero), NULLIF(col.nombre, ''), CONCAT('C.P. ', NULLIF(col.codigo_postal, '')), NULLIF(m.nombre, ''), NULLIF(e.nombre, '') ) AS direccionCompleta
        FROM sucursal s
        INNER JOIN direccion d ON s.idDireccion = d.idDireccion
        LEFT JOIN colonias col ON d.idColonia = col.id
        LEFT JOIN municipios m ON col.municipio = m.id
        LEFT JOIN estados e ON m.estado = e.id
        WHERE s.idSucursal = #{idSucursal}
    </select>

    <insert id="registrar-sucursal" parameterType="pojo.Sucursal">
        INSERT INTO sucursal (codigo, nombre, estatus, idDireccion) 
        VALUES (#{codigo}, #{nombre}, 'activa', #{idDireccion})
    </insert>
    
    <update id="editar-sucursal" parameterType="pojo.Sucursal">
        UPDATE sucursal SET 
            nombre = #{nombre}
        WHERE idSucursal = #{idSucursal}
    </update>

    <update id="baja-sucursal" parameterType="int">
        UPDATE sucursal SET 
            estatus = 'inactiva'
        WHERE idSucursal = #{idSucursal}
    </update>
    
    <select id="verificar-nombre" resultType="int" parameterType="string">
        SELECT COUNT(*) FROM sucursal WHERE nombre = #{nombre}
    </select>
    
    <select id="verificar-codigo" resultType="int" parameterType="string">
        SELECT COUNT(*) FROM sucursal WHERE codigo = #{codigo}
    </select>
    
</mapper>